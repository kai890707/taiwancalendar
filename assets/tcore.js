const srcBase="./transform_data/",monthName=a=>["\u4E00\u6708","\u4E8C\u6708","\u4E09\u6708","\u56DB\u6708","\u4E94\u6708","\u516D\u6708","\u4E03\u6708","\u516B\u6708","\u4E5D\u6708","\u5341\u6708","\u5341\u4E00\u6708","\u5341\u4E8C\u6708"][a-1],getMonthIdx=a=>Number(a)-1,isWeekend=a=>a.week_chinese==="\u516D"||a.week_chinese==="\u65E5",isNationalHoliday=a=>a.caption&&/節|假|春節|國慶|中秋|除夕|勞動|清明|光復|行憲|元旦|紀念日|小年夜/.test(a.caption);function findHolidayBlocks(a){let d=[],l=[];for(const o of a){if(o.caption&&o.caption.match(/補班|補行上班/)){l.length&&d.push(l),l=[];continue}o.isHoliday?l.push(o):(l.length&&d.push(l),l=[])}return l.length&&d.push(l),d}function isWeekendBlock(a){return a.length===2&&isWeekend(a[0])&&isWeekend(a[1])&&!a[0].caption&&!a[1].caption}function hasNationalHoliday(a){return a.some(isNationalHoliday)}function makeBestVacationAdvices(a,d=4){let l=new Map;for(let e=0;e<a.length;e++){if(!a[e].isHoliday&&!isNationalHoliday(a[e])&&!isWeekend(a[e]))continue;let r=[],i=[],s=0,t=new Set;for(let n=e;n<a.length;n++){let c=a[n];if(c.caption&&c.caption.match(/補班|補行上班/))break;if(c.isHoliday||isNationalHoliday(c))i.push(c),c.caption&&t.add(c.caption);else if(isWeekend(c))i.push(c);else if(s<d)r.push(c),i.push(c),s++;else break;if((isNationalHoliday(a[n])||isWeekend(a[n]))&&(isNationalHoliday(a[e])||isWeekend(a[e]))&&i.length>=4&&r.length>0&&i.length===n-e+1){let y=r.map($=>$.date).join(",");(!l.has(y)||i.length>l.get(y).block.length)&&l.set(y,{block:i.slice(),ask:r.slice(),caption:[...t].filter($=>$).join("\u3001")||"\u9023\u5047"})}}}let o=[];l.forEach((e,r)=>{let i=e.block,s=e.ask,t=`${parseInt(i[0].month)}/${parseInt(i[0].day)} - ${parseInt(i[i.length-1].month)}/${parseInt(i[i.length-1].day)}`;o.push({range:t,start:i[0].date,caption:e.caption,choices:[{ask:s.length,days:i.length,askDates:s.map(n=>`${parseInt(n.month)}/${parseInt(n.day)}\uFF08${n.week_chinese}\uFF09`),detail:i.map(n=>`${parseInt(n.month)}/${parseInt(n.day)}${n.caption?"/"+n.caption:""}\uFF08${n.week_chinese}\uFF09`).join("\u3001"),range:t,caption:e.caption}]})});let p=[],k=e=>`${e.range}##${e.caption}`,f=new Map;for(let e of o){let r=k(e);f.has(r)||f.set(r,{...e,choices:[]}),f.get(r).choices.push(...e.choices)}return p=Array.from(f.values()),p.forEach(e=>{e.choices.sort((s,t)=>t.days-s.days||s.ask-t.ask);let r=e.choices[0]?.days,i=Math.min(...e.choices.filter(s=>s.days===r).map(s=>s.ask));e.choices=e.choices.filter(s=>s.days==r&&s.ask==i&&s.days>=4)}),p=p.filter(e=>e.choices.length>0),p.sort((e,r)=>e.start.localeCompare(r.start)),p}function renderMaxVacTableRaw(a){let d="";for(const l of a){let o=l.choices[0],p=new Set,k={},f=h=>{let g,w;if(typeof h=="string"&&h.includes("/")){let I=h.split("/");return g=String(parseInt(I[0],10)).padStart(2,"0"),w=String(parseInt(I[1],10)).padStart(2,"0"),g+"/"+w}return h},e=l.caption.split(/、|；|,/).map(h=>h.trim()).filter(Boolean);o.askDates.forEach(h=>p.add(f(h)));let r=o.detail.split("\u3001")[0],i=r.match(/^(\d+)\/(\d+)/);if(!i)continue;let s=i[1],t=i[2],n="2025",c=new Date(`${n}/${s}/${t}`);if(!c||isNaN(c.getTime()))continue;let u=new Date(c),y=0;for(;u.getDay()!==6&&y++<7;)u.setDate(u.getDate()-1);if(y>7)continue;let $=[];for(let h=0;h<9;h++){let g=new Date(u.getTime());g.setDate(g.getDate()+h);let w=String(g.getMonth()+1).padStart(2,"0"),I=String(g.getDate()).padStart(2,"0"),M=`${w}/${I}`,v=o.detail.split("\u3001").find(D=>D.startsWith(parseInt(w)+"/"+parseInt(I))),S;p.has(M)?S="maxvac-leave":v&&e.some(D=>D&&v.includes(D))?S="maxvac-holiday":g.getDay()===0||g.getDay()===6?S="maxvac-weekend":S="maxvac-normal",$.push(`<td class="${S}">${parseInt(w)}/${parseInt(I)}</td>`)}let m=r.split("/")[0]+"\u6708";d+=`<tr class="text-center align-middle"><td>${m}</td><td>${l.caption}</td>`,d+=`<td>${o.range}</td><td>${o.days}\u5929</td>`,d+=`<td>${o.askDates.length>0?"\u8ACB"+o.askDates.length+"\u4F11"+o.days+"</br>"+o.askDates.join("\u3001"):"\u4E0D\u7528\u8ACB\u5047"}</td>`,d+=$.join(""),d+="</tr>"}document.getElementById("maxVacationTableBody").innerHTML=d}async function loadCalendar(a){let d=srcBase+`${a}.json`,l=await fetch(d).then(t=>t.json()),o=l.filter(t=>t.isHoliday),p=l.filter(t=>t.caption&&(t.caption.includes("\u88DC\u884C\u4E0A\u73ED")||t.caption.includes("\u88DC\u73ED"))||t.week_chinese=="\u516D"&&!t.isHoliday&&t.caption);document.getElementById("holidayList").innerHTML=`<li class="list-group-item fw-bold">\u653E\u5047\u65E5\uFF1A${o.length}\u5929</li>`+o.filter(t=>t.caption).map(t=>`<li class="list-group-item holiday">
    <span class="date-fixed-width me-2">${String(t.month).padStart(2,"0")}/${String(t.day).padStart(2,"0")}\uFF08${t.week_chinese}\uFF09</span>${t.caption}
    <span class="badge tag-holiday ms-2">\u5047</span>
  </li>`).join(""),document.getElementById("makeupList").innerHTML=p.length?`<li class="list-group-item fw-bold">\u88DC\u73ED\u65E5\uFF1A${p.length}\u5929</li>`+p.map(t=>`<li class="list-group-item makeup">
  <span class="date-fixed-width me-2">${String(t.month).padStart(2,"0")}/${String(t.day).padStart(2,"0")}\uFF08${t.week_chinese}\uFF09</span>${t.caption}
  <span class="badge tag-makeup ms-2">\u88DC\u73ED</span>
</li>`).join(""):"";let k=new Array(12).fill(0);o.forEach(t=>k[getMonthIdx(t.month)]++);let f=Math.max(...k,1);document.getElementById("barchart").innerHTML=k.map((t,n)=>`<div class="d-flex align-items-center mb-2">
    <span class="me-2" style="width:4em">${monthName(n+1)}</span>
    <div class="month-bar me-2" style="width:${t/f*85+5}%;min-width:10px"></div>
    <span class="text-primary fw-bold">${t||""}</span>
  </div>`).join("");let e=findHolidayBlocks(l).filter(t=>t.length>=2&&hasNationalHoliday(t)&&!isWeekendBlock(t));e.sort((t,n)=>t[0].date.localeCompare(n[0].date));let r=e.map(t=>{let n=[...new Set(t.map(m=>m.caption).filter(Boolean))],c=n.length?n.join("\u3001")+"\u9023\u5047":"\u9023\u7E8C\u5047\u671F",u=`${parseInt(t[0].month)}/${parseInt(t[0].day)} - ${parseInt(t[t.length-1].month)}/${parseInt(t[t.length-1].day)}`,y=t.map(m=>`${parseInt(m.month)}/${parseInt(m.day)}\uFF08${m.week_chinese}${m.caption?"/"+m.caption:""}\uFF09`).join("\u3001");return{name:c,range:u,days:t.length,detail:y,advice:"-",block_first:t[0].date}});r.sort((t,n)=>t.block_first.localeCompare(n.block_first)),document.querySelector("#longbreakTable thead tr").innerHTML="<th>\u9023\u5047\u540D\u7A31</th><th>\u7BC4\u570D</th><th>\u9023\u4F11\u5929\u6578</th><th>\u8A73\u7D30\u65E5\u671F</th><th>\u8ACB\u5047\u653B\u7565</th>",document.querySelector("#longbreakTable tbody").innerHTML=r.length?r.map(t=>`<tr>
      <td>${t.name}</td>
      <td>${t.range}</td>
      <td>${t.days}</td>
      <td>${t.detail}</td>
      <td>${t.advice||"-"}</td>
    </tr>`).join(""):"<tr><td colspan=5>\u672C\u5E74\u7121\u9023\u7E8C\u5047\u65E5</td></tr>";let i=makeBestVacationAdvices(l,4);renderMaxVacTableRaw(i);let s='<ul class="mb-0">';i.length||(s+="<li>\u672C\u5E74\u66AB\u7121\u986F\u8457\u300C\u6700\u5927\u5316\u300D\u8ACB\u5047\u60C5\u5883</li>"),i.forEach(t=>{s+=`<li class="mb-2"><b>${t.range}</b> <span class="text-info">[${t.caption}]</span><ul>`,t.choices.forEach(n=>{let c=n.ask?`\u8ACB${n.ask}\u5929 (${n.askDates.join("\u3001")})`:"\u4E0D\u7528\u8ACB\u5047";s+=`<li>${c}\u53EF\u4F11${n.days}\u5929\uFF0C${n.detail}</li>`}),s+="</ul></li>"}),s+="</ul>",document.getElementById("bestVacationAdvice").innerHTML=s}document.getElementById("copyrightYear").textContent=new Date().getFullYear();